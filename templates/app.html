<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEUROBOT | AI Assistant</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>
<body class="black-theme">
    <!-- WELCOME SCREEN -->
    <div id="welcome-screen" class="welcome-screen">
        <div class="welcome-card">
            <div class="brand">
                <div class="robot-icon">
                    <i class="fas fa-robot"></i>
                </div>
                <h1>NEUROBOT</h1>
                <p class="subtitle">Your cute AI companion ðŸ¤–</p>
            </div>
            <div class="input-group">
                <div class="input-container">
                    <textarea id="first-prompt" placeholder="What's on your mind? ðŸ’­ Start chatting with me!" autofocus></textarea>
                </div>
                <button id="start-btn" class="cute-btn">
                    <i class="fas fa-sparkles"></i>
                    Start Chatting
                </button>
            </div>
        </div>
    </div>

    <!-- MAIN CHAT APP -->
    <div id="chat-app" class="chat-app" style="display: none;">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-title">
                    <i class="fas fa-history"></i>
                    <h2>Chat History</h2>
                </div>
                <div class="search-box">
                    <input type="text" id="history-search" placeholder="ðŸ” Search chats..." />
                </div>
                <div class="sidebar-actions">
                    <button id="new-chat-btn" class="btn-action cute-tooltip" data-tooltip="New Chat">
                        <i class="fas fa-plus"></i>
                    </button>
                    <button id="fullscreen-btn" class="btn-action cute-tooltip" data-tooltip="Fullscreen">
                        <i class="fas fa-expand"></i>
                    </button>
                    <button id="theme-toggle-btn" class="btn-action cute-tooltip" data-tooltip="Toggle Theme">
                        <i class="fas fa-sun"></i>
                    </button>
                    <button id="close-sidebar-btn" class="btn-action cute-tooltip" data-tooltip="Close Sidebar">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            <div id="history-list" class="history-list"></div>
        </div>

        <!-- Main Chat Area -->
        <div class="main-area" id="main-area">
            <!-- Toggle Button (Only shows when sidebar is closed) -->
            <button id="sidebar-toggle-btn" class="sidebar-toggle-btn" style="display: none;">
                <i class="fas fa-bars"></i>
            </button>

            <div class="chat-header">
                <div class="header-left">
                    <div class="system-info">
                        <span class="status online">ðŸŸ¢ Systems Online</span>
                    </div>
                </div>
                <div class="header-center">
                    <div class="logo-container">
                        <img src="{{ url_for('static', filename='logo.png') }}" alt="NEUROBOT AI" class="app-logo">
                        <span class="logo-text">NEUROBOT AI</span>
                    </div>
                </div>
                <div class="header-right">
                    <span class="time-display" id="current-time">--:--:--</span>
                </div>
            </div>

            <div class="chat-container" id="chat-container">
                <div class="welcome-message">
                    <div class="welcome-card-main">
                        <div class="welcome-robot">ðŸ¤–</div>
                        <h3>Hello! I'm Neurobot!</h3>
                        <p>I have two brains - one logical ðŸ§  and one creative ðŸŽ¨. Ask me anything or upload files for me to analyze!</p>
                        <div class="welcome-features">
                            <div class="feature">
                                <i class="fas fa-brain"></i>
                                <span>Smart Logic</span>
                            </div>
                            <div class="feature">
                                <i class="fas fa-palette"></i>
                                <span>Creative Ideas</span>
                            </div>
                            <div class="feature">
                                <i class="fas fa-file-pdf"></i>
                                <span>PDF Analysis</span>
                            </div>
                            <div class="feature">
                                <i class="fas fa-robot"></i>
                                <span>Always Learning</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="input-bar">
                <div id="selected-files" class="selected-files"></div>
                <div class="input-wrapper">
                    <textarea id="prompt-input" placeholder="Type your message here... ðŸ’¬ Or upload a file to discuss!" maxlength="1000"></textarea>
                    <div class="action-buttons">
                        <div class="file-upload-btn">
                            <input type="file" id="file-input" class="file-input" accept=".pdf,.txt,.jpg,.jpeg,.png,.doc,.docx" />
                            <i class="fas fa-paperclip"></i>
                        </div>
                        <button id="ask-btn" class="send-btn cute-send">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // DOM Elements
        const welcomeScreen = document.getElementById('welcome-screen');
        const chatApp = document.getElementById('chat-app');
        const firstPrompt = document.getElementById('first-prompt');
        const startBtn = document.getElementById('start-btn');
        const promptInput = document.getElementById('prompt-input');
        const askBtn = document.getElementById('ask-btn');
        const chatContainer = document.getElementById('chat-container');
        const historyList = document.getElementById('history-list');
        const newChatBtn = document.getElementById('new-chat-btn');
        const fullscreenBtn = document.getElementById('fullscreen-btn');
        const closeSidebarBtn = document.getElementById('close-sidebar-btn');
        const sidebarToggleBtn = document.getElementById('sidebar-toggle-btn');
        const themeToggleBtn = document.getElementById('theme-toggle-btn');
        const sidebar = document.getElementById('sidebar');
        const mainArea = document.getElementById('main-area');
        const currentTime = document.getElementById('current-time');
        const fileInput = document.getElementById('file-input');
        const selectedFiles = document.getElementById('selected-files');

        // State
        let isSidebarOpen = true;
        let currentFiles = [];

        // File handling functions
        function handleFileSelect(event) {
            const files = Array.from(event.target.files);
            
            files.forEach(file => {
                if (!currentFiles.some(f => f.name === file.name && f.size === file.size)) {
                    currentFiles.push(file);
                }
            });
            
            updateFileDisplay(selectedFiles, currentFiles);
            event.target.value = '';
        }

        function updateFileDisplay(container, files) {
            container.innerHTML = '';
            files.forEach((file, index) => {
                const filePill = document.createElement('div');
                filePill.className = `file-pill ${getFileType(file)}`;
                filePill.innerHTML = `
                    <i class="fas ${getFileIcon(file)} file-icon"></i>
                    <span class="file-name">${file.name}</span>
                    <button class="file-pill-remove" onclick="removeFile(${index})">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                container.appendChild(filePill);
            });
        }

        function getFileType(file) {
            if (file.type.includes('pdf')) return 'pdf';
            if (file.type.includes('image')) return 'image';
            if (file.type.includes('text')) return 'text';
            if (file.type.includes('document') || file.name.endsWith('.doc') || file.name.endsWith('.docx')) return 'document';
            return 'other';
        }

        function getFileIcon(file) {
            switch (getFileType(file)) {
                case 'pdf': return 'fa-file-pdf';
                case 'image': return 'fa-file-image';
                case 'text': return 'fa-file-alt';
                case 'document': return 'fa-file-word';
                default: return 'fa-file';
            }
        }

        function removeFile(index) {
            currentFiles.splice(index, 1);
            updateFileDisplay(selectedFiles, currentFiles);
        }

        async function readFileAsBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            updateTime();
            setInterval(updateTime, 1000);
            updateSidebarToggleVisibility();
            
            // File input event listeners
            fileInput.addEventListener('change', handleFileSelect);
        });

        function updateTime() {
            const now = new Date();
            currentTime.textContent = now.toLocaleTimeString('en-US', { 
                hour12: false,
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }

        // Theme System
        function toggleTheme() {
            document.body.classList.toggle('black-theme');
            document.body.classList.toggle('white-theme');
            
            const icon = themeToggleBtn.querySelector('i');
            if (document.body.classList.contains('white-theme')) {
                icon.className = 'fas fa-moon';
                themeToggleBtn.setAttribute('data-tooltip', 'Dark Mode');
            } else {
                icon.className = 'fas fa-sun';
                themeToggleBtn.setAttribute('data-tooltip', 'Light Mode');
            }
        }

        // Fullscreen
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }

        function updateFullscreenButton() {
            const icon = fullscreenBtn.querySelector('i');
            if (document.fullscreenElement) {
                icon.className = 'fas fa-compress';
                fullscreenBtn.setAttribute('data-tooltip', 'Exit Fullscreen');
            } else {
                icon.className = 'fas fa-expand';
                fullscreenBtn.setAttribute('data-tooltip', 'Fullscreen');
            }
        }

        // Sidebar Functions
        function toggleSidebar() {
            isSidebarOpen = !isSidebarOpen;
            
            if (isSidebarOpen) {
                sidebar.classList.remove('sidebar-closed');
                mainArea.classList.remove('main-full');
            } else {
                sidebar.classList.add('sidebar-closed');
                mainArea.classList.add('main-full');
            }
            updateSidebarToggleVisibility();
        }

        function updateSidebarToggleVisibility() {
            if (isSidebarOpen) {
                sidebarToggleBtn.style.display = 'none';
            } else {
                sidebarToggleBtn.style.display = 'flex';
            }
        }

        // History
        function filterHistory() {
            const query = document.getElementById('history-search').value.toLowerCase();
            document.querySelectorAll('.history-item').forEach(item => {
                const matches = item.textContent.toLowerCase().includes(query);
                item.style.display = matches ? 'flex' : 'none';
            });
        }

        function addToHistory(prompt, hasFiles = false) {
            const item = document.createElement('div');
            item.className = 'history-item';
            const fileIndicator = hasFiles ? ' ðŸ“Ž' : '';
            item.innerHTML = `
                <i class="fas fa-comment"></i>
                <span>${prompt.substring(0, 35)}${prompt.length > 35 ? '...' : ''}${fileIndicator}</span>
                <small>${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</small>
            `;
            item.addEventListener('click', () => {
                promptInput.value = prompt;
                promptInput.focus();
            });
            historyList.prepend(item);
        }

        // Messages
        function appendUserMessage(text, files = []) {
            const welcomeMessage = document.querySelector('.welcome-message');
            if (welcomeMessage) welcomeMessage.remove();
            
            const msg = document.createElement('div');
            msg.className = 'message user-message';
            
            let fileIndicator = '';
            if (files.length > 0) {
                fileIndicator = `<div class="file-attachments">
                    <i class="fas fa-paperclip"></i>
                    ${files.length} file${files.length > 1 ? 's' : ''} attached
                </div>`;
            }
            
            msg.innerHTML = `
                <div class="avatar">ðŸ‘¤</div>
                <div class="message-content">
                    <div class="bubble">${escapeHtml(text)}</div>
                    ${fileIndicator}
                    <div class="message-time">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
                </div>
            `;
            chatContainer.appendChild(msg);
            smoothScrollToBottom();
        }

        function createResponseGroup() {
            const group = document.createElement('div');
            group.className = 'response-group';
            group.innerHTML = `
                <div class="ai-pair">
                    <div class="ai-card logic-card">
                        <div class="card-header">
                            <div class="badge logic-badge">
                                <i class="fas fa-brain"></i>
                                Logical Brain ðŸ§ 
                            </div>
                        </div>
                        <div class="thinking logic-thinking">
                            <div class="dots">
                                <span></span>
                                <span></span>
                                <span></span>
                            </div>
                            Thinking logically...
                        </div>
                        <div class="response logic-response"></div>
                    </div>
                    <div class="ai-card creative-card">
                        <div class="card-header">
                            <div class="badge creative-badge">
                                <i class="fas fa-palette"></i>
                                Creative Mind ðŸŽ¨
                            </div>
                        </div>
                        <div class="thinking creative-thinking">
                            <div class="dots">
                                <span></span>
                                <span></span>
                                <span></span>
                            </div>
                            Getting creative...
                        </div>
                        <div class="response creative-response"></div>
                    </div>
                </div>
            `;
            return group;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Streaming
        async function streamResponses(prompt, responseGroup, files = []) {
            const logicResponse = responseGroup.querySelector('.logic-response');
            const creativeResponse = responseGroup.querySelector('.creative-response');
            const logicThinking = responseGroup.querySelector('.logic-thinking');
            const creativeThinking = responseGroup.querySelector('.creative-thinking');
            
            let logicText = '';
            let creativeText = '';
            
            try {
                // Prepare request data
                const requestData = {
                    prompt: prompt,
                    files: []
                };

                // Convert files to base64 if any
                if (files.length > 0) {
                    for (const file of files) {
                        const base64Data = await readFileAsBase64(file);
                        requestData.files.push({
                            name: file.name,
                            data: base64Data,
                            type: file.type
                        });
                    }
                }

                const res = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestData)
                });
                
                if (!res.ok) throw new Error('Network error');
                
                const data = await res.json();
                
                // Display responses
                if (data.logic_response) {
                    logicResponse.textContent = data.logic_response;
                    logicThinking.style.display = 'none';
                }
                
                if (data.creative_response) {
                    creativeResponse.textContent = data.creative_response;
                    creativeThinking.style.display = 'none';
                }
                
                if (data.file_processed) {
                    logicResponse.innerHTML += '<div class="file-processed-indicator">ðŸ“Ž File content analyzed</div>';
                    creativeResponse.innerHTML += '<div class="file-processed-indicator">ðŸ“Ž File content analyzed</div>';
                }
                
                smoothScrollToBottom();
                
            } catch (err) {
                console.error('Stream error:', err);
                logicResponse.innerHTML = '<div class="error">ðŸ˜… Oops! Something went wrong</div>';
                creativeResponse.innerHTML = '<div class="error">ðŸ˜… Oops! Something went wrong</div>';
                logicThinking.style.display = 'none';
                creativeThinking.style.display = 'none';
            }
        }

        // Utilities
        function smoothScrollToBottom() {
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // Chat Flow
        async function startChat(prompt) {
            if (!prompt.trim()) return;
            
            welcomeScreen.style.opacity = '0';
            setTimeout(() => {
                welcomeScreen.style.display = 'none';
                chatApp.style.display = 'flex';
                setTimeout(() => chatApp.style.opacity = '1', 50);
            }, 300);
            
            addToHistory(prompt, false);
            appendUserMessage(prompt, []);
            
            const group = createResponseGroup();
            chatContainer.appendChild(group);
            
            firstPrompt.value = '';
            promptInput.focus();
            
            await streamResponses(prompt, group, []);
        }

        async function handleAsk(prompt) {
            if (!prompt.trim() && currentFiles.length === 0) return;
            
            const hasFiles = currentFiles.length > 0;
            addToHistory(prompt || `File upload: ${currentFiles.map(f => f.name).join(', ')}`, hasFiles);
            appendUserMessage(prompt || `Analyzing ${currentFiles.length} file(s)`, currentFiles);
            
            const group = createResponseGroup();
            chatContainer.appendChild(group);
            
            promptInput.value = '';
            
            await streamResponses(prompt, group, currentFiles);
            currentFiles = [];
            updateFileDisplay(selectedFiles, currentFiles);
        }

        function startNewChat() {
            chatContainer.innerHTML = `
                <div class="welcome-message">
                    <div class="welcome-card-main">
                        <div class="welcome-robot">ðŸ¤–</div>
                        <h3>Hello! I'm Neurobot!</h3>
                        <p>I have two brains - one logical ðŸ§  and one creative ðŸŽ¨. Ask me anything or upload files for me to analyze!</p>
                        <div class="welcome-features">
                            <div class="feature">
                                <i class="fas fa-brain"></i>
                                <span>Smart Logic</span>
                            </div>
                            <div class="feature">
                                <i class="fas fa-palette"></i>
                                <span>Creative Ideas</span>
                            </div>
                            <div class="feature">
                                <i class="fas fa-file-pdf"></i>
                                <span>PDF Analysis</span>
                            </div>
                            <div class="feature">
                                <i class="fas fa-robot"></i>
                                <span>Always Learning</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            promptInput.focus();
            currentFiles = [];
            updateFileDisplay(selectedFiles, currentFiles);
        }

        // Event Listeners
        startBtn.addEventListener('click', () => startChat(firstPrompt.value));
        askBtn.addEventListener('click', () => handleAsk(promptInput.value));
        newChatBtn.addEventListener('click', startNewChat);
        fullscreenBtn.addEventListener('click', toggleFullscreen);
        closeSidebarBtn.addEventListener('click', toggleSidebar);
        sidebarToggleBtn.addEventListener('click', toggleSidebar);
        themeToggleBtn.addEventListener('click', toggleTheme);
        
        firstPrompt.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                startChat(firstPrompt.value);
            }
        });
        
        promptInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                handleAsk(promptInput.value);
            }
        });
        
        document.getElementById('history-search').addEventListener('input', filterHistory);
        document.addEventListener('fullscreenchange', updateFullscreenButton);

        // Make functions globally available for file removal
        window.removeFile = removeFile;
    </script>
</body>
</html>
