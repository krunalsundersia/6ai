<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEUROBOT | AI Assistant</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>
<body class="black-theme">
    <!-- WELCOME SCREEN -->
    <div id="welcome-screen" class="welcome-screen">
        <div class="welcome-card">
            <div class="brand">
                <div class="robot-icon">
                    <i class="fas fa-robot"></i>
                </div>
                <h1>NEUROBOT</h1>
                <p class="subtitle">Your cute AI companion 🤖</p>
            </div>
            <div class="input-group">
                <div class="input-container">
                    <textarea id="first-prompt" placeholder="What's on your mind? 💭" autofocus></textarea>
                </div>
                <button id="start-btn" class="cute-btn">
                    <i class="fas fa-sparkles"></i>
                    Start Chatting
                </button>
            </div>
        </div>
    </div>

    <!-- MAIN CHAT APP -->
    <div id="chat-app" class="chat-app" style="display: none;">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-title">
                    <i class="fas fa-history"></i>
                    <h2>Chat History</h2>
                </div>
                <div class="search-box">
                    <input type="text" id="history-search" placeholder="🔍 Search chats..." />
                </div>
                <div class="sidebar-actions">
                    <button id="new-chat-btn" class="btn-action cute-tooltip" data-tooltip="New Chat">
                        <i class="fas fa-plus"></i>
                    </button>
                    <button id="fullscreen-btn" class="btn-action cute-tooltip" data-tooltip="Fullscreen">
                        <i class="fas fa-expand"></i>
                    </button>
                    <button id="theme-toggle-btn" class="btn-action cute-tooltip" data-tooltip="Toggle Theme">
                        <i class="fas fa-sun"></i>
                    </button>
                    <button id="close-sidebar-btn" class="btn-action cute-tooltip" data-tooltip="Close Sidebar">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            <div id="history-list" class="history-list"></div>
        </div>

        <!-- Main Chat Area -->
        <div class="main-area" id="main-area">
            <!-- Toggle Button (Only shows when sidebar is closed) -->
            <button id="sidebar-toggle-btn" class="sidebar-toggle-btn" style="display: none;">
                <i class="fas fa-bars"></i>
            </button>

            <div class="chat-header">
                <div class="header-left">
                    <div class="system-info">
                        <span class="status online">🟢 Systems Online</span>
                    </div>
                </div>
                <div class="header-center">
                    <span class="app-title">NEUROBOT AI</span>
                </div>
                <div class="header-right">
                    <span class="time-display" id="current-time">--:--:--</span>
                </div>
            </div>

            <div class="chat-container" id="chat-container">
                <div class="welcome-message">
                    <div class="welcome-card-main">
                        <div class="welcome-robot">🤖</div>
                        <h3>Hello! I'm Neurobot!</h3>
                        <p>I have two brains - one logical 🧠 and one creative 🎨. Ask me anything!</p>
                        <div class="welcome-features">
                            <div class="feature">
                                <i class="fas fa-brain"></i>
                                <span>Smart Logic</span>
                            </div>
                            <div class="feature">
                                <i class="fas fa-palette"></i>
                                <span>Creative Ideas</span>
                            </div>
                            <div class="feature">
                                <i class="fas fa-robot"></i>
                                <span>Always Learning</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="input-bar">
                <div class="input-wrapper">
                    <textarea id="prompt-input" placeholder="Type your message here... 💬" maxlength="1000"></textarea>
                    <button id="ask-btn" class="send-btn cute-send">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // DOM Elements
        const welcomeScreen = document.getElementById('welcome-screen');
        const chatApp = document.getElementById('chat-app');
        const firstPrompt = document.getElementById('first-prompt');
        const startBtn = document.getElementById('start-btn');
        const promptInput = document.getElementById('prompt-input');
        const askBtn = document.getElementById('ask-btn');
        const chatContainer = document.getElementById('chat-container');
        const historyList = document.getElementById('history-list');
        const newChatBtn = document.getElementById('new-chat-btn');
        const fullscreenBtn = document.getElementById('fullscreen-btn');
        const closeSidebarBtn = document.getElementById('close-sidebar-btn');
        const sidebarToggleBtn = document.getElementById('sidebar-toggle-btn');
        const themeToggleBtn = document.getElementById('theme-toggle-btn');
        const sidebar = document.getElementById('sidebar');
        const mainArea = document.getElementById('main-area');
        const currentTime = document.getElementById('current-time');

        // State
        let isSidebarOpen = true;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            updateTime();
            setInterval(updateTime, 1000);
            updateSidebarToggleVisibility();
        });

        function updateTime() {
            const now = new Date();
            currentTime.textContent = now.toLocaleTimeString('en-US', { 
                hour12: false,
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }

        // Theme System
        function toggleTheme() {
            document.body.classList.toggle('black-theme');
            document.body.classList.toggle('white-theme');
            
            const icon = themeToggleBtn.querySelector('i');
            if (document.body.classList.contains('white-theme')) {
                icon.className = 'fas fa-moon';
                themeToggleBtn.setAttribute('data-tooltip', 'Dark Mode');
            } else {
                icon.className = 'fas fa-sun';
                themeToggleBtn.setAttribute('data-tooltip', 'Light Mode');
            }
        }

        // Fullscreen
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }

        function updateFullscreenButton() {
            const icon = fullscreenBtn.querySelector('i');
            if (document.fullscreenElement) {
                icon.className = 'fas fa-compress';
                fullscreenBtn.setAttribute('data-tooltip', 'Exit Fullscreen');
            } else {
                icon.className = 'fas fa-expand';
                fullscreenBtn.setAttribute('data-tooltip', 'Fullscreen');
            }
        }

        // Sidebar Functions
        function toggleSidebar() {
            isSidebarOpen = !isSidebarOpen;
            
            if (isSidebarOpen) {
                sidebar.classList.remove('sidebar-closed');
                mainArea.classList.remove('main-full');
            } else {
                sidebar.classList.add('sidebar-closed');
                mainArea.classList.add('main-full');
            }
            updateSidebarToggleVisibility();
        }

        function updateSidebarToggleVisibility() {
            if (isSidebarOpen) {
                sidebarToggleBtn.style.display = 'none';
            } else {
                sidebarToggleBtn.style.display = 'flex';
            }
        }

        // History
        function filterHistory() {
            const query = document.getElementById('history-search').value.toLowerCase();
            document.querySelectorAll('.history-item').forEach(item => {
                const matches = item.textContent.toLowerCase().includes(query);
                item.style.display = matches ? 'flex' : 'none';
            });
        }

        function addToHistory(prompt) {
            const item = document.createElement('div');
            item.className = 'history-item';
            item.innerHTML = `
                <i class="fas fa-comment"></i>
                <span>${prompt.substring(0, 35)}${prompt.length > 35 ? '...' : ''}</span>
                <small>${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</small>
            `;
            item.addEventListener('click', () => {
                promptInput.value = prompt;
                promptInput.focus();
            });
            historyList.prepend(item);
        }

        // Messages
        function appendUserMessage(text) {
            const welcomeMessage = document.querySelector('.welcome-message');
            if (welcomeMessage) welcomeMessage.remove();
            
            const msg = document.createElement('div');
            msg.className = 'message user-message';
            msg.innerHTML = `
                <div class="avatar">👤</div>
                <div class="message-content">
                    <div class="bubble">${escapeHtml(text)}</div>
                    <div class="message-time">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
                </div>
            `;
            chatContainer.appendChild(msg);
            smoothScrollToBottom();
        }

        function createResponseGroup() {
            const group = document.createElement('div');
            group.className = 'response-group';
            group.innerHTML = `
                <div class="ai-pair">
                    <div class="ai-card logic-card">
                        <div class="card-header">
                            <div class="badge logic-badge">
                                <i class="fas fa-brain"></i>
                                Logical Brain 🧠
                            </div>
                        </div>
                        <div class="thinking logic-thinking">
                            <div class="dots">
                                <span></span>
                                <span></span>
                                <span></span>
                            </div>
                            Thinking logically...
                        </div>
                        <div class="response logic-response"></div>
                    </div>
                    <div class="ai-card creative-card">
                        <div class="card-header">
                            <div class="badge creative-badge">
                                <i class="fas fa-palette"></i>
                                Creative Mind 🎨
                            </div>
                        </div>
                        <div class="thinking creative-thinking">
                            <div class="dots">
                                <span></span>
                                <span></span>
                                <span></span>
                            </div>
                            Getting creative...
                        </div>
                        <div class="response creative-response"></div>
                    </div>
                </div>
            `;
            return group;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // AskLurk
        function showAskLurkButton(responseGroup) {
            const row = document.createElement('div');
            row.className = 'asklurk-row';
            row.innerHTML = `
                <button class="asklurk-btn">
                    <i class="fas fa-robot"></i>
                    Combine Answers ✨
                </button>
            `;
            
            responseGroup.appendChild(row);
            const btn = row.querySelector('button');
            btn.onclick = () => runAskLurkMerge(responseGroup, btn);
        }

        async function runAskLurkMerge(responseGroup, btn) {
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Combining...';
            
            const logicText = responseGroup.querySelector('.logic-response').textContent;
            const creativeText = responseGroup.querySelector('.creative-response').textContent;
            
            try {
                const res = await fetch('/asklurk', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        answers: { logic: logicText, creative: creativeText },
                        prompt: promptInput.value 
                    })
                });
                
                if (res.ok) {
                    const data = await res.json();
                    if (data.best) {
                        const bestCard = document.createElement('div');
                        bestCard.className = 'ai-card best-card';
                        bestCard.innerHTML = `
                            <div class="card-header">
                                <div class="badge best-badge">
                                    <i class="fas fa-star"></i>
                                    Best Answer ⭐
                                </div>
                            </div>
                            <div class="response">${escapeHtml(data.best)}</div>
                        `;
                        responseGroup.appendChild(bestCard);
                        smoothScrollToBottom();
                    }
                }
            } catch (err) {
                console.error('AskLurk error:', err);
                btn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Oops! Try again';
            }
        }

        // Streaming
        async function streamResponses(prompt, responseGroup) {
            const logicResponse = responseGroup.querySelector('.logic-response');
            const creativeResponse = responseGroup.querySelector('.creative-response');
            const logicThinking = responseGroup.querySelector('.logic-thinking');
            const creativeThinking = responseGroup.querySelector('.creative-thinking');
            
            let logicText = '';
            let creativeText = '';
            
            try {
                const res = await fetch('/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt })
                });
                
                if (!res.ok) throw new Error('Network error');
                
                const reader = res.body.getReader();
                const decoder = new TextDecoder();
                
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const data = JSON.parse(line.slice(6));
                                
                                if (data.bot === 'logic' && data.text) {
                                    logicText += data.text;
                                    logicResponse.textContent = logicText;
                                    logicThinking.style.display = 'none';
                                }
                                else if (data.bot === 'creative' && data.text) {
                                    creativeText += data.text;
                                    creativeResponse.textContent = creativeText;
                                    creativeThinking.style.display = 'none';
                                }
                            } catch (e) {
                                // Skip invalid JSON
                            }
                        }
                    }
                    smoothScrollToBottom();
                }
                
                showAskLurkButton(responseGroup);
                
            } catch (err) {
                console.error('Stream error:', err);
                logicResponse.innerHTML = '<div class="error">😅 Oops! Something went wrong</div>';
                creativeResponse.innerHTML = '<div class="error">😅 Oops! Something went wrong</div>';
                logicThinking.style.display = 'none';
                creativeThinking.style.display = 'none';
            }
        }

        // Utilities
        function smoothScrollToBottom() {
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // Chat Flow
        async function startChat(prompt) {
            if (!prompt.trim()) return;
            
            welcomeScreen.style.opacity = '0';
            setTimeout(() => {
                welcomeScreen.style.display = 'none';
                chatApp.style.display = 'flex';
                setTimeout(() => chatApp.style.opacity = '1', 50);
            }, 300);
            
            addToHistory(prompt);
            appendUserMessage(prompt);
            
            const group = createResponseGroup();
            chatContainer.appendChild(group);
            
            firstPrompt.value = '';
            promptInput.focus();
            
            await streamResponses(prompt, group);
        }

        async function handleAsk(prompt) {
            if (!prompt.trim()) return;
            
            addToHistory(prompt);
            appendUserMessage(prompt);
            
            const group = createResponseGroup();
            chatContainer.appendChild(group);
            
            promptInput.value = '';
            
            await streamResponses(prompt, group);
        }

        function startNewChat() {
            chatContainer.innerHTML = `
                <div class="welcome-message">
                    <div class="welcome-card-main">
                        <div class="welcome-robot">🤖</div>
                        <h3>Hello! I'm Neurobot!</h3>
                        <p>I have two brains - one logical 🧠 and one creative 🎨. Ask me anything!</p>
                        <div class="welcome-features">
                            <div class="feature">
                                <i class="fas fa-brain"></i>
                                <span>Smart Logic</span>
                            </div>
                            <div class="feature">
                                <i class="fas fa-palette"></i>
                                <span>Creative Ideas</span>
                            </div>
                            <div class="feature">
                                <i class="fas fa-robot"></i>
                                <span>Always Learning</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            promptInput.focus();
        }

        // Event Listeners
        startBtn.addEventListener('click', () => startChat(firstPrompt.value));
        askBtn.addEventListener('click', () => handleAsk(promptInput.value));
        newChatBtn.addEventListener('click', startNewChat);
        fullscreenBtn.addEventListener('click', toggleFullscreen);
        closeSidebarBtn.addEventListener('click', toggleSidebar);
        sidebarToggleBtn.addEventListener('click', toggleSidebar);
        themeToggleBtn.addEventListener('click', toggleTheme);
        
        firstPrompt.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                startChat(firstPrompt.value);
            }
        });
        
        promptInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                handleAsk(promptInput.value);
            }
        });
        
        document.getElementById('history-search').addEventListener('input', filterHistory);
        document.addEventListener('fullscreenchange', updateFullscreenButton);
    </script>
</body>
</html>
